<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.back.admin.repository.UserRepository">

    <select id="countByLoginId" parameterType="string" resultType="int">
        /* sql : UserRepository.countByLoginId */
        SELECT  COUNT(*)
        FROM 	TB_USER
        WHERE	LOGIN_ID = #{login_id}
    </select>

    <insert id="save" parameterType="userEntity">
        /* sql : UserRepository.save */
        INSERT INTO TB_USER (
            USER_ID,
            LOGIN_ID,
            USER_NM,
            USER_PW,
            TEL_NO,
            CREATED_AT,
            CREATED_ID
        )
        VALUES (
            'US'||LPAD(NEXTVAL('SEQ_USER')||'', 8, '0'),
            #{login_id},
            #{user_nm},
            #{user_pw},
            #{tel_no},
            now(),
            #{created_id}
        )
    </insert>


    <update id="update" parameterType="userEntity">
        /* sql : UserRepository.update */
        UPDATE TB_USER
        SET  UPDATED_AT = now()
        ,UPDATED_ID = #{updated_id}
        <if test='user_nm != "" and user_nm != null'>
            , USER_NM = #{user_nm}
        </if>
        <if test='user_pw != "" and user_pw != null'>
            , USER_PW = #{user_pw}
        </if>
        <if test='tel_no != "" and tel_no != null'>
            , TEL_NO = #{tel_no}
        </if>
        <if test='pw_init_yn != "" and pw_init_yn != null'>
            , PW_INIT_YN = #{pw_init_yn}
        </if>
        <if test='pw_fail_init != "" and pw_fail_init != null'>
            , PW_FAIL_CNT = #{pw_fail_cnt}
        </if>
        <if test='use_yn != "" and use_yn != null'>
            , USE_YN = #{use_yn}
        </if>
        WHERE USER_ID = #{user_id}
    </update>


    <select id="findAll" parameterType="userEntity" resultType="userEntity">
        SELECT  ROW_NUMBER() OVER (ORDER BY USER_ID DESC) RNUM,
                USER_ID,
                LOGIN_ID,
                USER_NM,
                USER_PW,
                TEL_NO,
                USE_YN,
                FN_GETCODENM('USE_YN', USE_YN) AS USE_YN_NM,
                TO_CHAR(LAST_LOGIN_AT, 'YYYY-MM-DD HH24:MI') AS LAST_LOGIN_AT,
                CREATED_AT,
                UPDATED_AT,
                CREATED_ID,
                UPDATED_ID
        FROM    TB_USER
        WHERE 1=1
        <if test="login_id != null and login_id != ''">
        AND 	UPPER(LOGIN_ID) LIKE '%'||UPPER(#{login_id})||'%'
        </if>
        <if test="user_nm != null and user_nm != ''">
        AND 	UPPER(USER_NM) LIKE '%'||UPPER(#{user_nm})||'%'
        </if>
        <if test="use_yn != null and use_yn != ''">
        AND 	USE_YN = #{use_yn}
        </if>
        ORDER BY USER_ID DESC
        OFFSET 	#{start_idx} limit #{page_per}
    </select>


    <select id="countByAll" parameterType="userEntity" resultType="int">
        SELECT  COUNT(*)
        FROM    TB_USER
        WHERE 1=1
        <if test="login_id != null and login_id != ''">
        AND 	UPPER(LOGIN_ID) LIKE '%'||UPPER(#{login_id})||'%'
        </if>
        <if test="user_nm != null and user_nm != ''">
        AND 	UPPER(USER_NM) LIKE '%'||UPPER(#{user_nm})||'%'
        </if>
        <if test="use_yn != null and use_yn != ''">
        AND 	USE_YN = #{use_yn}
        </if>
    </select>


    <select id="findByUserId" parameterType="string" resultType="userEntity">
        SELECT  USER_ID,
                LOGIN_ID,
                USER_NM,
                USER_PW,
                TEL_NO,
                USE_YN,
                FN_GETCODENM('USE_YN', USE_YN) AS USE_YN_NM,
                CREATED_AT,
                UPDATED_AT,
                CREATED_ID,
                UPDATED_ID,
                PW_FAIL_CNT,
                TO_CHAR(LAST_LOGIN_AT, 'YYYY-MM-DD HH24:MI') AS LAST_LOGIN_AT,
                PW_INIT_YN
        FROM    TB_USER
        WHERE   USER_ID = #{user_id}
    </select>

    <delete id="deleteByUserid" parameterType="string">
        DELETE FROM TB_USER
        WHERE USER_ID = #{user_id}
    </delete>

</mapper>