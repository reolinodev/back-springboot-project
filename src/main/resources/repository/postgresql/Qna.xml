<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.back.admin.repository.QnaRepository">

    <select id="findAll" parameterType="qnaEntity" resultType="qnaEntity">
        /* sql : QnaRepository.findAll */
        SELECT *
        FROM    (
                    SELECT  ROW_NUMBER() OVER (ORDER BY A.QNA_ID DESC) RNUM,
                            A.QNA_ID,
                            A.BOARD_ID,
                            A.QNA_TITLE,
                            TO_CHAR(A.CREATED_AT, 'YYYY-MM-DD HH24:MI') AS CREATED_AT,
                            TO_CHAR(A.UPDATED_AT, 'YYYY-MM-DD HH24:MI') AS UPDATED_AT,
                            TO_CHAR(A.RESPONSE_AT, 'YYYY-MM-DD HH24:MI') AS RESPONSE_AT,
                            A.CREATED_ID,
                            A.UPDATED_ID,
                            A.RESPONSE_ID,
                            FN_GETUSERNM(A.CREATED_ID) AS CREATED_NM,
                            FN_GETUSERNM(A.UPDATED_ID) AS UPDATED_NM,
                            FN_GETUSERNM(A.RESPONSE_ID) AS RESPONSE_NM,
                            A.USE_YN,
                            FN_GETCODENM('USE_YN', A.USE_YN) AS USE_YN_NM,
                            B.BOARD_TITLE,
                            A.RESPONSE_YN,
                            FN_GETCODENM('RESPONSE_YN', A.RESPONSE_YN) AS RESPONSE_YN_NM
                    FROM    TB_QNA A,
                            TB_BOARD B
                    WHERE   A.BOARD_ID = B.BOARD_ID
                    AND     B.USE_YN = 'Y'
                    <if test="start_date != null and start_date != ''">
                    AND     TO_CHAR(A.CREATED_AT, 'YYYY-MM-DD') BETWEEN #{start_date} AND #{end_date}
                    </if>
        ) A
        WHERE  1=1
        <if test="response_yn != null and response_yn != ''">
        AND     A.RESPONSE_YN = #{response_yn}
        </if>
        <if test="use_yn != null and use_yn != ''">
        AND     A.USE_YN = #{use_yn}
        </if>
        <if test="board_id != null and board_id != ''">
        AND     A.BOARD_ID = #{board_id}
        </if>
        <if test="search_str != null and search_str != ''">
        AND     (UPPER(A.QNA_TITLE) LIKE  '%'||UPPER(#{search_str})||'%'
        OR UPPER(A.CREATED_NM) LIKE  '%'||UPPER(#{search_str})||'%')
        </if>
    </select>

    <select id="countAll" parameterType="qnaEntity" resultType="int">
        /* sql : QnaRepository.countAll */
        SELECT COUNT(*)
        FROM    (
                    SELECT  A.QNA_ID,
                            A.BOARD_ID,
                            A.QNA_TITLE,
                            TO_CHAR(A.CREATED_AT, 'YYYY-MM-DD HH24:MI') AS CREATED_AT,
                            TO_CHAR(A.UPDATED_AT, 'YYYY-MM-DD HH24:MI') AS UPDATED_AT,
                            TO_CHAR(A.RESPONSE_AT, 'YYYY-MM-DD HH24:MI') AS RESPONSE_AT,
                            A.CREATED_ID,
                            A.UPDATED_ID,
                            A.RESPONSE_ID,
                            FN_GETUSERNM(A.CREATED_ID) AS CREATED_NM,
                            FN_GETUSERNM(A.UPDATED_ID) AS UPDATED_NM,
                            FN_GETUSERNM(A.RESPONSE_ID) AS RESPONSE_NM,
                            A.USE_YN,
                            FN_GETCODENM('USE_YN', A.USE_YN) AS USE_YN_NM,
                            B.BOARD_TITLE,
                            A.RESPONSE_YN,
                            FN_GETCODENM('RESPONSE_YN', A.RESPONSE_YN) AS RESPONSE_YN_NM
                    FROM    TB_QNA A,
                            TB_BOARD B
                    WHERE   A.BOARD_ID = B.BOARD_ID
                    AND     B.USE_YN = 'Y'
                    <if test="start_date != null and start_date != ''">
                    AND     TO_CHAR(A.CREATED_AT, 'YYYY-MM-DD') BETWEEN #{start_date} AND #{end_date}
                    </if>
        ) A
        WHERE  1=1
        <if test="response_yn != null and response_yn != ''">
        AND     A.RESPONSE_YN = #{response_yn}
        </if>
        <if test="use_yn != null and use_yn != ''">
        AND     A.USE_YN = #{use_yn}
        </if>
        <if test="board_id != null and board_id != ''">
        AND     A.BOARD_ID = #{board_id}
        </if>
        <if test="search_str != null and search_str != ''">
        AND     (UPPER(A.QNA_TITLE) LIKE  '%'||UPPER(#{search_str})||'%'
        OR UPPER(A.CREATED_NM) LIKE  '%'||UPPER(#{search_str})||'%')
        </if>

    </select>

    <insert id="save" parameterType="qnaEntity">
        /* sql : QnaRepository.save */
        INSERT INTO TB_QNA
        (
            QNA_ID,
            BOARD_ID,
            QNA_TITLE,
            QUESTIONS,
            HIDDEN_YN,
            <if test="qna_pw != null and qna_pw != ''">
            QNA_PW,
            </if>
            CREATED_AT,
            CREATED_ID
        )
        VALUES
        (
            'QA'||LPAD(nextval('SEQ_QNA')||'', 8, '0'),
            #{board_id},
            #{qna_title},
            #{questions},
            #{hidden_yn},
            <if test="qna_pw != null and qna_pw != ''">
            #{qna_pw},
            </if>
            now(),
            #{created_id}
        )
    </insert>

    <select id="findByQnaId" parameterType="string" resultType="qnaEntity">
        /* sql : QnaRepository.findByQnaId */
        SELECT  A.QNA_ID,
                A.BOARD_ID,
                A.QNA_TITLE,
                A.MAIN_TEXT,
                A.QUESTIONS,
                A.CREATED_ID,
                A.UPDATED_ID,
                A.RESPONSE_ID,
                FN_GETUSERNM(A.CREATED_ID) AS CREATED_NM,
                FN_GETUSERNM(A.UPDATED_ID) AS UPDATED_NM,
                FN_GETUSERNM(A.RESPONSE_ID) AS RESPONSE_NM,
                TO_CHAR(A.CREATED_AT, 'YYYY-MM-DD HH24:MI') AS CREATED_AT,
                TO_CHAR(A.UPDATED_AT, 'YYYY-MM-DD HH24:MI') AS UPDATED_AT,
                TO_CHAR(A.RESPONSE_AT, 'YYYY-MM-DD HH24:MI') AS RESPONSE_AT,
                B.BOARD_TITLE,
                A.USE_YN,
                A.RESPONSE_YN,
                FN_GETCODENM('RESPONSE_YN', A.RESPONSE_YN) AS RESPONSE_YN_NM,
                A.HIDDEN_YN
        FROM    TB_QNA A,
                TB_BOARD B
        WHERE   A.BOARD_ID = B.BOARD_ID
          AND   B.USE_YN = 'Y'
          AND   A.QNA_ID = #{qna_id}
    </select>

    <update id="update" parameterType="qnaEntity">
        /* sql : QnaRepository.updateQna */
        UPDATE  TB_QNA
        SET     UPDATED_AT = now()
        <if test="updated_id != null and updated_id != ''">
                , UPDATED_ID = #{updated_id}
        </if>
        <if test="qna_title != null and qna_title != ''">
                , QNA_TITLE = #{qna_title}
        </if>
        <if test="questions != null and questions != ''">
                , QUESTIONS = #{questions}
        </if>
        <if test="main_text != null and main_text != ''">
                , MAIN_TEXT = #{main_text}
        </if>
        <if test="response_yn != null and response_yn != ''">
                , RESPONSE_YN = #{response_yn}
                , RESPONSE_ID = #{response_id}
                , RESPONSE_AT = now()
        </if>
        <if test="use_yn != null and use_yn != ''">
            , USE_YN = #{use_yn}
        </if>
        <if test="hidden_yn != null and hidden_yn != ''">
            , HIDDEN_YN = #{hidden_yn}
            <choose>
                <when test='hidden_yn == "N"'>
                    , QNA_PW = NULL
                </when>
                <otherwise>
                    <if test="qna_pw != null and qna_pw != ''">
                        , QNA_PW = #{qna_pw}
                    </if>
                </otherwise>
            </choose>
        </if>
        WHERE   QNA_ID = #{qna_id}
    </update>

    <select id="countByQnaIdAndQnaPw" parameterType="qnaEntity" resultType="int">
        SELECT  COUNT(*)
        FROM    TB_QNA
        WHERE   QNA_ID = #{qna_id}
        AND     QNA_PW = #{qna_pw}
    </select>
</mapper>