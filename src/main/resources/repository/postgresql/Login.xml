<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.back.admin.repository.LoginRepository">

    <select id="countByLoginId" parameterType="loginEntity" resultType="int">
        /* sql : LoginRepository.countByLoginId */
        SELECT	COUNT(*)
        FROM 	TB_USER
        WHERE 	LOGIN_ID = #{login_id}
        AND 	USE_YN = 'Y'
    </select>

    <select id="countByLoginIdAndUserPw" parameterType="loginEntity" resultType="int">
        /* sql : LoginRepository.countByLoginIdAndUserPw */
        SELECT  COUNT(*)
        FROM 	TB_USER
        WHERE 	LOGIN_ID = #{login_id}
        AND 	USER_PW = #{user_pw}
        AND 	USE_YN = 'Y'
    </select>

    <select id="findByLoginId" parameterType="string" resultType="loginEntity">
        /* sql : LoginRepository.findByLoginId */
        SELECT  A.USER_ID,
                A.LOGIN_ID,
                A.USER_NM,
                C.AUTH_NM,
                C.AUTH_ID,
                A.PW_FAIL_CNT,
                A.PW_INIT_YN,
                A.USER_PW,
                A.LAST_LOGIN_DT
        FROM 	TB_USER A,
                TB_USER_AUTH B,
                TB_AUTH C
        WHERE 	A.USER_ID = B.USER_ID
          AND 	B.AUTH_ID = C.AUTH_ID
          AND 	B.USE_YN ='Y'
          AND 	A.LOGIN_ID = #{login_id}
        ORDER BY ORD
            LIMIT 1
    </select>

    <update id="saveLastLoginDt" parameterType="loginEntity">
        /* sql : LoginRepository.saveLastLoginDt */
        UPDATE 	TB_USER
        SET 	LAST_LOGIN_DT = now(),
                PW_FAIL_CNT = 0
        WHERE 	LOGIN_ID = #{login_id}
    </update>

    <update id="savePwfailCnt" parameterType="loginEntity">
        /* sql : LoginRepository.savePwfailCnt */
        UPDATE 	TB_USER
        SET 	UPDATED_AT = now(),
                PW_FAIL_CNT = PW_FAIL_CNT + 1
        WHERE 	LOGIN_ID = #{login_id}
    </update>

    <insert id="saveToken" parameterType="loginEntity">
        /* sql : LoginRepository.saveToken */
        WITH UPSERT AS (
        UPDATE  TB_LOGIN
        SET UPDATED_AT = now()
        <if test="access_token != null and access_token != ''">
            , ACCESS_TOKEN = #{access_token}
        </if>
        <if test="refresh_token != null and refresh_token != ''">
            , REFRESH_TOKEN = #{refresh_token}
        </if>
        WHERE   LOGIN_ID = #{login_id}
        RETURNING *
        )
        INSERT INTO TB_LOGIN (LOGIN_ID, ACCESS_TOKEN, REFRESH_TOKEN, UPDATED_AT)
        SELECT  #{login_id}, #{access_token},  #{refresh_token} ,now()
        WHERE NOT EXISTS(SELECT * FROM UPSERT)
    </insert>

    <select id="findTokenByAccessToken" parameterType="loginEntity" resultType="loginEntity">
        /* sql : LoginRepository.findTokenByAccessToken */
        SELECT  LOGIN_ID,
                ACCESS_TOKEN,
                REFRESH_TOKEN,
                UPDATED_AT
        FROM 	TB_LOGIN
        WHERE 	ACCESS_TOKEN = #{access_token}
    </select>

    <insert id="saveLoginHistory" parameterType="loginEntity">
        /* sql : LoginRepository.saveLoginHistory */
        INSERT INTO TB_LOGIN_HISTORY
        (
            USER_ID,
            LOGIN_DEVICE,
            DEVICE_BROWSER,
            CREATED_AT
        )
        VALUES
        (
            #{user_id},
            #{login_device},
            #{device_browser},
            now()
        )
    </insert>
</mapper>